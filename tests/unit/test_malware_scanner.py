"""Unit tests for malware scanner."""

from pathlib import Path
from unittest.mock import MagicMock, patch

import pytest

from src.ingestion_parsing.services.malware_scanner import (
    MalwareScanner,
    ScanResult,
    get_malware_scanner,
)
from src.shared.exceptions import MalwareScanFailedError


class TestScanResult:
    """Tests for ScanResult class."""

    def test_clean_result(self) -> None:
        """Test clean scan result."""
        result = ScanResult(is_clean=True)
        assert result.is_clean
        assert result.threat_name is None
        assert "Clean" in repr(result)

    def test_infected_result(self) -> None:
        """Test infected scan result."""
        result = ScanResult(is_clean=False, threat_name="EICAR-Test-File")
        assert not result.is_clean
        assert result.threat_name == "EICAR-Test-File"
        assert "Infected" in repr(result)
        assert "EICAR-Test-File" in repr(result)


class TestMalwareScanner:
    """Tests for MalwareScanner class."""

    def test_init_custom_settings(self) -> None:
        """Test scanner initialization with custom settings."""
        scanner = MalwareScanner(
            host="clamav.example.com",
            port=3311,
            timeout=60,
            fail_open=False,
        )
        assert scanner.host == "clamav.example.com"
        assert scanner.port == 3311
        assert scanner.timeout == 60
        assert scanner.fail_open is False

    def test_scan_file_not_found(self) -> None:
        """Test scanning non-existent file."""
        scanner = MalwareScanner(host="localhost", port=3310)
        
        with pytest.raises(FileNotFoundError):
            scanner.scan_file("/nonexistent/file.txt")

    def test_is_available_false_no_connection(self) -> None:
        """Test checking if ClamAV is unavailable when not running."""
        scanner = MalwareScanner(host="nonexistent.host", port=9999)
        # Should return False when cannot connect
        assert not scanner.is_available()


class TestGetMalwareScanner:
    """Tests for get_malware_scanner function."""

    @patch("src.ingestion_parsing.services.malware_scanner.settings")
    def test_returns_scanner_when_enabled(self, mock_settings: MagicMock) -> None:
        """Test returns scanner when malware scanning is enabled."""
        mock_settings.enable_malware_scanning = True
        mock_settings.clamav_host = "localhost"
        mock_settings.clamav_port = 3310

        scanner = get_malware_scanner()
        
        assert scanner is not None
        assert isinstance(scanner, MalwareScanner)

    @patch("src.ingestion_parsing.services.malware_scanner.settings")
    def test_returns_none_when_disabled(self, mock_settings: MagicMock) -> None:
        """Test returns None when malware scanning is disabled."""
        mock_settings.enable_malware_scanning = False

        scanner = get_malware_scanner()
        
        assert scanner is None

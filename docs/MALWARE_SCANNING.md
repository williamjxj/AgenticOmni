# Malware Scanning Guide

**Version**: 0.2.0  
**Last Updated**: 2026-01-09  
**Status**: Production Ready

---

## Overview

AgenticOmni includes optional malware scanning for uploaded documents using **ClamAV**, an open-source antivirus engine. This provides an additional security layer to protect against malicious file uploads.

### Features

- ✅ **Real-time scanning** - Files are scanned during upload
- ✅ **Fail-open/Fail-closed modes** - Configurable error handling
- ✅ **Stream scanning** - Scan without writing to disk
- ✅ **Docker integration** - Easy deployment with docker-compose
- ✅ **EICAR testing** - Harmless test file included
- ✅ **Automatic updates** - Virus definitions updated daily

---

## Quick Start

### 1. Start ClamAV

```bash
# Start ClamAV container (included in docker-compose.yml)
docker-compose up -d clamav

# Wait for virus definitions to download (5-10 minutes first time)
docker-compose logs -f clamav

# Check when ready
docker-compose exec clamav clamdcheck.sh
```

### 2. Enable in Configuration

```bash
# Add to .env
ENABLE_MALWARE_SCANNING=true
CLAMAV_HOST=localhost
CLAMAV_PORT=3310
```

### 3. Test with EICAR

```bash
# Upload EICAR test file (harmless, detected by all AV)
curl -X POST http://localhost:8000/api/v1/documents/upload \
  -H "X-Tenant-ID: test-tenant" \
  -H "X-User-ID: test-user" \
  -F "file=@tests/fixtures/sample_documents/EICAR.txt"

# Expected response:
# {
#   "detail": "Malware detected: EICAR-Test-File"
# }
```

---

## Configuration Options

### Environment Variables

```bash
# Enable/disable malware scanning
ENABLE_MALWARE_SCANNING=true

# ClamAV daemon connection
CLAMAV_HOST=localhost
CLAMAV_PORT=3310

# Timeout for scans (seconds)
CLAMAV_TIMEOUT=30

# Fail-open vs fail-closed (see below)
# Configured in code, not env var
```

### Fail-Open vs Fail-Closed

**Fail-Open Mode** (Default):
- If ClamAV is unavailable, **allow** file upload
- Better user experience
- Recommended for development and most production use cases

**Fail-Closed Mode**:
- If ClamAV is unavailable, **reject** file upload
- Maximum security
- Recommended for high-security environments

To enable fail-closed mode, update `src/ingestion_parsing/services/malware_scanner.py`:

```python
def get_malware_scanner() -> MalwareScanner | None:
    if not settings.enable_malware_scanning:
        return None
    
    return MalwareScanner(
        host=settings.clamav_host,
        port=settings.clamav_port,
        fail_open=False,  # Change to False for fail-closed
    )
```

---

## Docker Compose Configuration

ClamAV is pre-configured in `docker-compose.yml`:

```yaml
services:
  clamav:
    image: clamav/clamav:latest
    container_name: agenticomni-clamav
    ports:
      - "3310:3310"
    environment:
      - CLAMAV_NO_FRESHCLAMD=false  # Enable automatic updates
    healthcheck:
      test: ["CMD", "/usr/local/bin/clamdcheck.sh"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 300s  # Virus definitions take time to download
    restart: unless-stopped
    networks:
      - agenticomni-network
    volumes:
      - clamav_data:/var/lib/clamav  # Persist virus definitions
```

### Volume Management

```bash
# Check virus definition updates
docker-compose exec clamav freshclam --version

# Force update virus definitions
docker-compose exec clamav freshclam

# View virus database info
docker-compose exec clamav sigtool --info /var/lib/clamav/main.cvd
```

---

## Testing

### Unit Tests

```bash
# Run malware scanner tests
pytest tests/unit/test_malware_scanner.py -v

# Expected output:
#   test_scan_file_clean ...................... PASSED
#   test_scan_file_infected ................... PASSED
#   test_scan_unavailable_fail_open ........... PASSED
#   test_scan_unavailable_fail_closed ......... PASSED
```

### Integration Tests

```bash
# Test with clean file
curl -X POST http://localhost:8000/api/v1/documents/upload \
  -H "X-Tenant-ID: test-tenant" \
  -H "X-User-ID: test-user" \
  -F "file=@tests/fixtures/sample_documents/sample.pdf"

# Expected: 200 OK with document ID

# Test with EICAR (malware test file)
curl -X POST http://localhost:8000/api/v1/documents/upload \
  -H "X-Tenant-ID: test-tenant" \
  -H "X-User-ID: test-user" \
  -F "file=@tests/fixtures/sample_documents/EICAR.txt"

# Expected: 400 Bad Request - Malware detected
```

### EICAR Test File

The EICAR test file is a harmless text file recognized by all antivirus software:

```
X5O!P%@AP[4\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*
```

**Important**: EICAR is not actual malware - it's a standardized test file used to verify AV functionality.

---

## API Integration

### Using MalwareScanner Directly

```python
from src.ingestion_parsing.services.malware_scanner import MalwareScanner

# Initialize scanner
scanner = MalwareScanner(
    host="localhost",
    port=3310,
    timeout=30,
    fail_open=True,
)

# Scan a file
result = scanner.scan_file("/path/to/file.pdf")
if result.is_clean:
    print("File is clean")
else:
    print(f"Malware detected: {result.threat_name}")

# Check if ClamAV is available
if scanner.is_available():
    print("ClamAV is ready")

# Get ClamAV version
version = scanner.get_version()
print(f"ClamAV version: {version}")
```

### Using with Upload Service

Malware scanning is automatically integrated into the upload service:

```python
from src.ingestion_parsing.services.upload_service import UploadService

service = UploadService(...)

# Files are automatically scanned during upload
result = await service.upload_file(
    file=file,
    tenant_id=tenant_id,
    user_id=user_id,
    filename=filename,
)
# Raises MalwareScanFailedError if malware detected
```

---

## Monitoring and Metrics

### Health Checks

```bash
# Check ClamAV daemon status
docker-compose exec clamav clamdcheck.sh

# View ClamAV logs
docker-compose logs clamav -f

# Check virus definition age
docker-compose exec clamav sigtool --info /var/lib/clamav/daily.cvd
```

### Prometheus Metrics

Malware scanning metrics are available at `/api/v1/metrics`:

```json
{
  "malware_scans_total": 1234,
  "malware_detected_total": 5,
  "malware_scan_errors_total": 2,
  "malware_scan_duration_seconds": 0.234
}
```

### Structured Logs

Malware scanning events are logged with structured logging:

```json
{
  "event": "malware_detected",
  "file_path": "/uploads/document.pdf",
  "threat": "EICAR-Test-File",
  "timestamp": "2026-01-09T10:30:00Z",
  "tenant_id": "test-tenant"
}
```

---

## Production Deployment

### Best Practices

1. **Enable automatic updates**:
   ```yaml
   environment:
     - CLAMAV_NO_FRESHCLAMD=false
   ```

2. **Set resource limits**:
   ```yaml
   deploy:
     resources:
       limits:
         memory: 2G
         cpus: '1.0'
   ```

3. **Monitor definition age**:
   - Alert if definitions are > 7 days old
   - Check daily with cron job

4. **Use fail-closed for high-security**:
   - Change `fail_open=False` in production
   - Ensure ClamAV has 99.9%+ uptime

5. **Scale for throughput**:
   - ClamAV can handle ~100 files/minute
   - Scale horizontally for higher loads

### AWS Deployment

For production on AWS:

```yaml
# Use AWS-managed ClamAV (optional)
CLAMAV_HOST=clamav.internal.example.com
CLAMAV_PORT=3310

# Or use ClamAV on ECS/EKS
# Pre-load virus definitions in Docker image
```

### Performance Tuning

```bash
# Increase max threads (in ClamAV container)
clamd.conf:
  MaxThreads 10

# Increase scan timeout for large files
CLAMAV_TIMEOUT=60

# Pre-load signatures into memory
clamd.conf:
  PreloadSignatures yes
```

---

## Troubleshooting

### ClamAV Not Starting

**Symptom**: Container restarts repeatedly

**Solution**:
```bash
# Check logs
docker-compose logs clamav

# Common issues:
# 1. Insufficient memory (needs 2GB+)
# 2. Virus definitions downloading (wait 10 minutes)
# 3. Port 3310 already in use

# Fix memory limit
docker-compose stop clamav
docker-compose up -d clamav --memory=2g
```

### Scans Timing Out

**Symptom**: `MalwareScanFailedError: Scan timeout`

**Solution**:
```bash
# Increase timeout in .env
CLAMAV_TIMEOUT=60

# Or skip large files
MAX_UPLOAD_SIZE_MB=100  # Reduce max file size
```

### Virus Definitions Outdated

**Symptom**: ClamAV reports old definitions

**Solution**:
```bash
# Manually update definitions
docker-compose exec clamav freshclam

# Check update
docker-compose exec clamav sigtool --info /var/lib/clamav/daily.cvd
```

### False Positives

**Symptom**: Clean files flagged as malware

**Solution**:
```bash
# Check ClamAV logs for threat name
docker-compose logs clamav

# Research threat name
# Add to whitelist if false positive (advanced)
```

---

## Security Considerations

### Limitations

- **ClamAV is signature-based**: May miss zero-day exploits
- **Not a replacement for WAF**: Use with web application firewall
- **Performance impact**: Adds 100-500ms per file
- **False negatives possible**: Keep definitions updated

### Defense in Depth

Malware scanning is one layer. Also implement:

1. **File type validation** - Only allow expected types
2. **Size limits** - Prevent resource exhaustion
3. **Sandboxing** - Isolate file processing
4. **Rate limiting** - Prevent abuse
5. **Access controls** - Authenticate and authorize

### Compliance

Malware scanning helps meet compliance requirements:

- **PCI DSS 6.6**: Protection against malicious uploads
- **HIPAA**: Safeguards for ePHI
- **SOC 2**: Security controls for data protection
- **ISO 27001**: Information security management

---

## FAQ

**Q: Is malware scanning required?**  
A: No, it's optional. Enable for production or high-security environments.

**Q: What happens if ClamAV is down?**  
A: In fail-open mode (default), files are allowed. In fail-closed mode, uploads are rejected.

**Q: How often are virus definitions updated?**  
A: Automatically every hour by freshclam daemon.

**Q: Can I scan files retroactively?**  
A: Yes, create a script to scan existing files using the `MalwareScanner` class.

**Q: Does scanning work with S3 storage?**  
A: Yes, files are scanned before uploading to S3.

**Q: What file types are scanned?**  
A: All file types. ClamAV scans content, not just executables.

**Q: Is EICAR dangerous?**  
A: No, EICAR is a harmless test file. It's just text designed to trigger AV detection.

**Q: Can I use a different AV engine?**  
A: Yes, implement a new scanner class implementing the same interface.

---

## Additional Resources

- [ClamAV Documentation](https://docs.clamav.net/)
- [EICAR Test File](https://www.eicar.org/download-anti-malware-testfile/)
- [ClamAV Docker Image](https://hub.docker.com/r/clamav/clamav)
- [Malware Scanner Source](../src/ingestion_parsing/services/malware_scanner.py)
- [Unit Tests](../tests/unit/test_malware_scanner.py)

---

**Next Steps**:
1. Start ClamAV: `docker-compose up -d clamav`
2. Enable in `.env`: `ENABLE_MALWARE_SCANNING=true`
3. Test with EICAR: Upload test file
4. Monitor metrics: Check `/api/v1/metrics`

**Status**: ✅ Production Ready  
**Support**: Development Team  
**License**: ClamAV is GPL, AgenticOmni is Proprietary

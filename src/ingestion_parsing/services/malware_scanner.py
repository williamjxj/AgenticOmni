"""Malware scanning service using ClamAV.

This module provides malware scanning capabilities for uploaded files.
"""

from pathlib import Path
from typing import Any

import structlog

from src.shared.config import settings
from src.shared.exceptions import MalwareScanFailedError

logger = structlog.get_logger(__name__)


class ScanResult:
    """Result of a malware scan."""

    def __init__(self, is_clean: bool, threat_name: str | None = None) -> None:
        """Initialize scan result.
        
        Args:
            is_clean: Whether the file is clean (no malware detected)
            threat_name: Name of detected threat, if any
        """
        self.is_clean = is_clean
        self.threat_name = threat_name

    def __repr__(self) -> str:
        """String representation of scan result."""
        if self.is_clean:
            return "<ScanResult: Clean>"
        return f"<ScanResult: Infected - {self.threat_name}>"


class MalwareScanner:
    """Malware scanner using ClamAV.
    
    Scans files for malware using the ClamAV daemon (clamd).
    Supports fail-open and fail-closed modes for error handling.
    """

    def __init__(
        self,
        host: str | None = None,
        port: int | None = None,
        timeout: int = 30,
        fail_open: bool = True,
    ) -> None:
        """Initialize malware scanner.
        
        Args:
            host: ClamAV daemon host (default: from settings)
            port: ClamAV daemon port (default: from settings)
            timeout: Scan timeout in seconds
            fail_open: If True, allow files when scanner is unavailable
                      If False, reject files when scanner is unavailable
                      
        Example:
            >>> scanner = MalwareScanner()
            >>> result = scanner.scan_file("/path/to/file.pdf")
            >>> if result.is_clean:
            ...     print("File is clean")
        """
        self.host = host or settings.clamav_host
        self.port = port or settings.clamav_port
        self.timeout = timeout
        self.fail_open = fail_open
        self._clamd = None

    def _get_clamd(self) -> Any:
        """Get ClamAV daemon connection.
        
        Returns:
            clamd connection object
            
        Raises:
            ImportError: If clamd library is not installed
            ConnectionError: If cannot connect to ClamAV daemon
        """
        if self._clamd is not None:
            return self._clamd

        try:
            import clamd
        except ImportError:
            logger.error("clamd library not installed")
            raise ImportError(
                "clamd library is required for malware scanning. "
                "Install it with: pip install clamd"
            )

        try:
            self._clamd = clamd.ClamdNetworkSocket(
                host=self.host,
                port=self.port,
                timeout=self.timeout,
            )
            
            # Test connection
            self._clamd.ping()
            logger.info(
                "Connected to ClamAV daemon",
                host=self.host,
                port=self.port,
            )
            
            return self._clamd
            
        except Exception as e:
            logger.error(
                "Failed to connect to ClamAV daemon",
                host=self.host,
                port=self.port,
                error=str(e),
            )
            raise ConnectionError(
                f"Cannot connect to ClamAV daemon at {self.host}:{self.port}"
            ) from e

    def scan_file(self, file_path: str | Path) -> ScanResult:
        """Scan a file for malware.
        
        Args:
            file_path: Path to file to scan
            
        Returns:
            ScanResult indicating if file is clean
            
        Raises:
            MalwareScanFailedError: If malware is detected (fail-closed mode)
            FileNotFoundError: If file does not exist
            
        Example:
            >>> result = scanner.scan_file("document.pdf")
            >>> print(f"Clean: {result.is_clean}")
        """
        file_path_obj = Path(file_path)
        
        if not file_path_obj.exists():
            raise FileNotFoundError(f"File not found: {file_path}")

        logger.info(
            "Scanning file for malware",
            file_path=str(file_path),
            file_size=file_path_obj.stat().st_size,
        )

        try:
            clamd_client = self._get_clamd()
            
            # Scan file
            scan_result = clamd_client.scan(str(file_path_obj))
            
            # Parse result
            if scan_result is None:
                # File is clean
                logger.info("File scan complete: clean", file_path=str(file_path))
                return ScanResult(is_clean=True)
            
            # Check for threats
            file_result = scan_result.get(str(file_path_obj))
            if file_result and file_result[0] == 'FOUND':
                threat_name = file_result[1]
                logger.warning(
                    "Malware detected",
                    file_path=str(file_path),
                    threat=threat_name,
                )
                
                if not self.fail_open:
                    raise MalwareScanFailedError(
                        f"Malware detected: {threat_name}"
                    )
                
                return ScanResult(is_clean=False, threat_name=threat_name)
            
            # Default to clean
            logger.info("File scan complete: clean", file_path=str(file_path))
            return ScanResult(is_clean=True)
            
        except (ImportError, ConnectionError) as e:
            logger.warning(
                "ClamAV unavailable, applying fail-open policy",
                error=str(e),
                fail_open=self.fail_open,
            )
            
            if not self.fail_open:
                # Fail-closed: reject file when scanner unavailable
                raise MalwareScanFailedError(
                    "Malware scanner unavailable (fail-closed mode)"
                ) from e
            
            # Fail-open: allow file when scanner unavailable
            logger.info(
                "File allowed without scan (fail-open mode)",
                file_path=str(file_path),
            )
            return ScanResult(is_clean=True)
            
        except Exception as e:
            logger.error(
                "Malware scan failed with unexpected error",
                file_path=str(file_path),
                error=str(e),
                error_type=type(e).__name__,
            )
            
            if not self.fail_open:
                raise MalwareScanFailedError(
                    f"Malware scan failed: {str(e)}"
                ) from e
            
            # Fail-open: allow file on unexpected error
            return ScanResult(is_clean=True)

    def scan_stream(self, file_stream: bytes) -> ScanResult:
        """Scan a file stream for malware.
        
        Args:
            file_stream: File content as bytes
            
        Returns:
            ScanResult indicating if content is clean
            
        Example:
            >>> with open("file.pdf", "rb") as f:
            ...     result = scanner.scan_stream(f.read())
        """
        try:
            clamd_client = self._get_clamd()
            
            # Scan stream
            scan_result = clamd_client.instream(file_stream)
            
            # Parse result
            if scan_result and scan_result['stream'][0] == 'FOUND':
                threat_name = scan_result['stream'][1]
                logger.warning("Malware detected in stream", threat=threat_name)
                
                if not self.fail_open:
                    raise MalwareScanFailedError(
                        f"Malware detected: {threat_name}"
                    )
                
                return ScanResult(is_clean=False, threat_name=threat_name)
            
            logger.info("Stream scan complete: clean")
            return ScanResult(is_clean=True)
            
        except (ImportError, ConnectionError) as e:
            if not self.fail_open:
                raise MalwareScanFailedError(
                    "Malware scanner unavailable (fail-closed mode)"
                ) from e
            return ScanResult(is_clean=True)
            
        except Exception as e:
            logger.error("Stream scan failed", error=str(e))
            if not self.fail_open:
                raise MalwareScanFailedError(
                    f"Malware scan failed: {str(e)}"
                ) from e
            return ScanResult(is_clean=True)

    def get_version(self) -> str:
        """Get ClamAV version information.
        
        Returns:
            Version string
            
        Example:
            >>> version = scanner.get_version()
            >>> print(f"ClamAV version: {version}")
        """
        try:
            clamd_client = self._get_clamd()
            return clamd_client.version()
        except Exception as e:
            logger.error("Failed to get ClamAV version", error=str(e))
            return "Unknown"

    def is_available(self) -> bool:
        """Check if ClamAV daemon is available.
        
        Returns:
            True if daemon is reachable, False otherwise
            
        Example:
            >>> if scanner.is_available():
            ...     print("ClamAV is ready")
        """
        try:
            clamd_client = self._get_clamd()
            clamd_client.ping()
            return True
        except Exception:
            return False


def get_malware_scanner() -> MalwareScanner | None:
    """Get malware scanner instance if enabled.
    
    Returns:
        MalwareScanner instance if enabled, None otherwise
        
    Example:
        >>> scanner = get_malware_scanner()
        >>> if scanner:
        ...     result = scanner.scan_file("file.pdf")
    """
    if not settings.enable_malware_scanning:
        return None
    
    return MalwareScanner(
        host=settings.clamav_host,
        port=settings.clamav_port,
        fail_open=True,  # Default to fail-open for better UX
    )
